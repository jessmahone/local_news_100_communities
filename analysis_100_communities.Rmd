---
title: "analysis_100_communities"
author: "Jessica Mahone"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(DBI)
library(RSQLite)

con <- dbConnect(RSQLite::SQLite(), "local_news_100_communities.db")

dbListTables(con)

```

```{sql connection=con}

PRAGMA table_info(communities)

```


```{sql connection=con, output.var = "cin_by_community_size"}

-- CIN story counts by community size

SELECT
  CASE
    WHEN c.population < 50000 THEN 'Small'
    WHEN c.population >= 50000 AND c.population < 200000 THEN 'Medium'
    ELSE 'Large'
  END AS community_size,
  s.critical_info_need,
  COUNT(*) AS story_count
FROM stories s
JOIN communities c ON s.community_id = c.community_id
WHERE s.critical_info_need IS NOT NULL
GROUP BY community_size, s.critical_info_need
ORDER BY community_size, story_count DESC;


```

```{r}

head(cin_by_community_size)
```

```{r}

library(scales)

cin_by_community_size %>%
  group_by(community_size) %>%
  mutate(proportion = story_count / sum(story_count)) %>%
  ungroup() %>%
  ggplot(aes(x = community_size, y = proportion, fill = critical_info_need)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Proportion of CIN Coverage by Community Size",
    x = "Community Size",
    y = "Proportion of Stories",
    fill = "CIN Category"
  ) +
  scale_y_continuous(labels = scales::percent_format()) +
  theme_minimal()

```

```{r}

cin_table <- cin_by_community_size %>%
  tidyr::pivot_wider(
    names_from = community_size,
    values_from = story_count,
    values_fill = 0
  ) %>%
  column_to_rownames("critical_info_need")

```

```{r}

chisq_test <- chisq.test(cin_table)
chisq_test


```

```{r}

cin_table_no_none <- cin_table[rownames(cin_table) != "None", ]
chisq.test(cin_table_no_none)

```

```{r}

# Define custom color palette for CIN categories
cin_colors <- c(
  "Emergencies/risks" = "#9ebc9e",         # muted green
  "Health" = "#b3cde3",                    # muted blue
  "Education" = "#cab2d6",                 # soft lavender
  "Transportation systems" = "#f2c9ac",    # soft peach
  "Economic development" = "#d9d9d9",      # light gray
  "Environment/planning" = "#bebada",      # lavender-gray
  "Civic information" = "#fdd9b5",         # warm beige
  "Political life" = "#cccccc"             # soft stone gray
)

# Create the proportion plot
cin_by_community_size %>%
  filter(critical_info_need != "None") %>%
  group_by(community_size) %>%
  mutate(proportion = story_count / sum(story_count)) %>%
  ungroup() %>%
  ggplot(aes(x = community_size, y = proportion, fill = critical_info_need)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.9), width = 1) +
  geom_text(aes(label = scales::percent(proportion, accuracy = 1)),
          position = position_dodge(width = 0.9),
          vjust = 1.2, size = 3, color = "black") +
  scale_fill_manual(values = cin_colors) +
  labs(
    title = "CIN Coverage by Community Size",
    subtitle = "Excludes stories that did not address a Critical Information Need",
    x = "Community Size",
    y = NULL,
    fill = "CIN Category"
  ) +
  theme_minimal() +
  theme(
    axis.ticks = element_blank(),
    axis.text.y = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    legend.position = "bottom",
    legend.title = element_text(size = 10),
    legend.text = element_text(size = 9)
  )

```

