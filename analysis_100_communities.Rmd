---
title: "analysis_100_communities"
author: "Jessica Mahone"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(DBI)
library(RSQLite)

con <- dbConnect(RSQLite::SQLite(), "local_news_100_communities.db")

dbListTables(con)

```

```{sql connection=con}

PRAGMA table_info(communities)

```


```{sql connection=con, output.var = "cin_by_community_size"}

-- CIN story counts by community size

SELECT
  CASE
    WHEN c.population < 50000 THEN 'Small'
    WHEN c.population >= 50000 AND c.population < 200000 THEN 'Medium'
    ELSE 'Large'
  END AS community_size,
  s.critical_info_need,
  COUNT(*) AS story_count
FROM stories s
JOIN communities c ON s.community_id = c.community_id
WHERE s.critical_info_need IS NOT NULL
GROUP BY community_size, s.critical_info_need
ORDER BY community_size, story_count DESC;


```

```{r}

head(cin_by_community_size)
```

```{r font stuff}

install.packages("showtext")
library(showtext)

font_add_google(name = "Inter", family = "Inter")
showtext_auto()

```


```{r}

library(scales)

cin_by_community_size %>%
  group_by(community_size) %>%
  mutate(proportion = story_count / sum(story_count)) %>%
  ungroup() %>%
  ggplot(aes(x = community_size, y = proportion, fill = critical_info_need)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Proportion of CIN Coverage by Community Size",
    x = "Community Size",
    y = "Proportion of Stories",
    fill = "CIN Category"
  ) +
  scale_y_continuous(labels = scales::percent_format()) +
  theme_minimal()

```

```{r cin chisq test}

cin_table <- cin_by_community_size %>%
  tidyr::pivot_wider(
    names_from = community_size,
    values_from = story_count,
    values_fill = 0
  ) %>%
  column_to_rownames("critical_info_need")

cin_table_no_none <- cin_table[rownames(cin_table) != "None", ]
chisq.test(cin_table_no_none)

```

```{r}

# Define custom color palette for CIN categories
cin_colors <- c(
  "Emergencies/risks"       = "#e07b91",  # muted rose
  "Health"                  = "#f4a582",  # soft coral
  "Education"               = "#92c5de",  # soft blue
  "Transportation systems" = "#b3b3cc",  # muted lavender
  "Economic development"    = "#c2a477",  # dusty gold
  "Environment/planning"    = "#a1d99b",  # gentle green
  "Civic information"       = "#d0b7d5",  # pale violet
  "Political life"          = "#80b1d3"   # dusty sky blue
)

# Create the proportion plot
cin_by_community_size %>%
  filter(critical_info_need != "None") %>%
  group_by(community_size) %>%
  mutate(proportion = story_count / sum(story_count)) %>%
  ungroup() %>%
  ggplot(aes(x = community_size, y = proportion, fill = critical_info_need)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.75), width = 0.6) +
  geom_text(
    aes(label = scales::percent(proportion, accuracy = 1)),
    position = position_dodge(width = 0.75),
    vjust = -0.4, size = 3, color = "black"
  ) +
  scale_fill_manual(values = cin_colors) +
  scale_x_discrete(labels = c(
    "Small" = "Small (<50k)",
    "Medium" = "Medium (50k–199k)",
    "Large" = "Large (200k–300k)"
  )) +
  labs(
    title = "Community Information Need Coverage by Community Size",
    subtitle = "Excludes stories that did not address a Critical Information Need",
    x = "Community Size",
    y = NULL,
    fill = "CIN Category"
  ) +
  theme_minimal(base_size = 11) +
  theme(
    axis.ticks = element_blank(),
    axis.text.y = element_blank(),
    panel.grid = element_blank(),
    legend.position = "bottom",
    legend.title = element_blank(),
    legend.text = element_text(size = 9),
    axis.text.x = element_text(face = "bold")
  )

```

```{r save CIN graphic}

ggsave("cin_by_community_size.png", width = 9, height = 6, dpi = 300)

```

```{sql connection=con, output.var = "local_by_community_size"}

SELECT
  CASE
    WHEN c.population < 50000 THEN 'Small'
    WHEN c.population >= 50000 AND c.population < 200000 THEN 'Medium'
    ELSE 'Large'
  END AS community_size,
  s.local,
  COUNT(*) AS local_story_count
FROM stories s
JOIN communities c ON s.community_id = c.community_id
WHERE s.local IS NOT NULL
GROUP BY community_size, s.local
ORDER BY community_size, local_story_count DESC;

```

```{r local chisq test}

local_table <- local_by_community_size %>%
  tidyr::pivot_wider(
    names_from = community_size,
    values_from = local_story_count,
    values_fill = 0
  ) %>%
  column_to_rownames("local")

chisq_test_local <- chisq.test(local_table)
chisq_test_local

```

```{r local_by_community_size chart}


local_by_community_size %>%
  group_by(community_size) %>%
  mutate(proportion = local_story_count / sum(local_story_count)) %>%
  ungroup() %>%
  ggplot(aes(x = community_size, y = proportion, fill = local)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.75), width = 0.6) +
  geom_text(
    aes(label = scales::percent(proportion, accuracy = 1)),
    position = position_dodge(width = 0.75),
    vjust = -0.4, size = 3, color = "black"
  ) +
  scale_fill_manual(
    values = c("Yes" = "#80b1d3", "No" = "#a1d99b"), 
    labels = c("Yes" = "Local", "No" = "Non-local")
  ) +
  scale_x_discrete(labels = c(
    "Small" = "Small (<50k)",
    "Medium" = "Medium (50k–199k)",
    "Large" = "Large (200k–300k)"
  )) +
  labs(
    title = "Local Story Coverage by Community Size",
    subtitle = "Proportion of stories categorized as local vs. non-local by community size",
    x = "Community Size",
    y = NULL,
    fill = NULL
  ) +
  theme_minimal(base_size = 11) +
  theme(
    axis.ticks = element_blank(),
    axis.text.y = element_blank(),
    panel.grid = element_blank(),
    legend.position = "bottom",
    legend.text = element_text(size = 9),
    axis.text.x = element_text(face = "bold")
  )

```

```{r save local graphic}

ggsave("local_by_community_size.png", width = 9, height = 6, dpi = 300)

```

```{sql connection=con, output.var="original_by_community_size"}

SELECT
  CASE
    WHEN c.population < 50000 THEN 'Small'
    WHEN c.population >= 50000 AND c.population < 200000 THEN 'Medium'
    ELSE 'Large'
  END AS community_size,
  s.original,
  COUNT(*) AS original_story_count
FROM stories s
JOIN communities c ON s.community_id = c.community_id
WHERE s.original IS NOT NULL
GROUP BY community_size, s.original
ORDER BY community_size, original_story_count DESC;

```

```{r chisq test}

original_table <- original_by_community_size %>%
  tidyr::pivot_wider(
    names_from = community_size,
    values_from = original_story_count,
    values_fill = 0
  ) %>%
  column_to_rownames("original")

chisq_test_original <- chisq.test(original_table)
chisq_test_original

```

```{r original_by_community_size chart}

original_by_community_size %>%
  group_by(community_size) %>%
  mutate(proportion = original_story_count / sum(original_story_count)) %>%
  ungroup() %>%
  ggplot(aes(x = community_size, y = proportion, fill = original)) +
  geom_bar(
    stat = "identity",
    position = position_dodge(width = 0.75),
    width = 0.6,
    color = "gray30"
  ) +
  geom_text(
    aes(label = scales::percent(proportion, accuracy = 1)),
    position = position_dodge(width = 0.75),
    vjust = 1.4,
    size = 4,
    fontface = "bold",
    color = "black"
  ) +
  scale_fill_manual(
    values = c(`Yes` = "#80b1d3", `No` = "#a1d99b"), 
    labels = c(`Yes` = "Original", `No` = "Not Original")
  ) +
  scale_x_discrete(labels = c(
    "Small" = "Small (<50k)",
    "Medium" = "Medium (50k–199k)",
    "Large" = "Large (200k–300k)"
  )) +
  labs(
    title = "Original Reporting by Community Size",
    subtitle = "Proportion of stories categorized as original reporting vs. from other sources",
    x = "Community Size",
    y = NULL,
    fill = NULL
  ) +
  theme_minimal(base_size = 11, base_family = "Inter") +
  theme(
    axis.ticks = element_blank(),
    axis.text.y = element_blank(),
    panel.grid = element_blank(),
    legend.position = "bottom",
    legend.text = element_text(size = 9),
    axis.text.x = element_text(face = "bold", size = 11),
    plot.title = element_text(size = 15, face = "bold"),
    plot.subtitle = element_text(size = 13)
  )

```

```{r save original graphic}

showtext_opts(dpi = 300)

ggsave("original_by_community_size.png", width = 8, height = 6, dpi = 300, units = "in")

```

